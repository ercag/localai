(()=>{"use strict";var e={97(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.MemoryService=void 0;const n="localai.chatHistory",o="localai.currentSession",i="localai.projectMemory";t.MemoryService=class{context;currentSession=null;constructor(e){this.context=e}async createNewSession(e){const t={id:`session_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,title:"New Chat",messages:[],model:e,createdAt:Date.now(),updatedAt:Date.now()};return this.currentSession=t,await this.saveCurrentSessionId(t.id),t}getCurrentSession(){return this.currentSession}async loadCurrentSession(){const e=this.context.workspaceState.get(o);if(!e)return null;const t=(await this.getAllSessions()).find(t=>t.id===e);return t&&(this.currentSession=t),t||null}async saveSession(e){if(e.updatedAt=Date.now(),"New Chat"===e.title&&e.messages.length>0){const t=e.messages.find(e=>"user"===e.role);t&&(e.title=t.content.substring(0,40)+(t.content.length>40?"...":""))}const t=await this.getAllSessions(),o=t.findIndex(t=>t.id===e.id);o>=0?t[o]=e:t.unshift(e);const i=t.slice(0,50);await this.context.workspaceState.update(n,i),this.currentSession=e}async getAllSessions(){return this.context.workspaceState.get(n)||[]}async deleteSession(e){const t=(await this.getAllSessions()).filter(t=>t.id!==e);await this.context.workspaceState.update(n,t),this.currentSession?.id===e&&(this.currentSession=null,await this.context.workspaceState.update(o,void 0))}async clearAllSessions(){await this.context.workspaceState.update(n,[]),await this.context.workspaceState.update(o,void 0),this.currentSession=null}async saveCurrentSessionId(e){await this.context.workspaceState.update(o,e)}async addMessage(e){this.currentSession&&(this.currentSession.messages.push(e),await this.saveSession(this.currentSession))}async getMessages(){return this.currentSession?.messages||[]}async clearCurrentMessages(){this.currentSession&&(this.currentSession.messages=[],await this.saveSession(this.currentSession))}async getProjectMemory(){const e=this.context.workspaceState.get(i);return e?{knownFiles:new Map(Object.entries(e.knownFiles||{})),projectNotes:e.projectNotes||"",commonCommands:e.commonCommands||[],updatedAt:e.updatedAt||Date.now()}:null}async saveProjectMemory(e){const t={knownFiles:Object.fromEntries(e.knownFiles),projectNotes:e.projectNotes,commonCommands:e.commonCommands,updatedAt:Date.now()};await this.context.workspaceState.update(i,t)}async addFileNote(e,t){let n=await this.getProjectMemory();n||(n={knownFiles:new Map,projectNotes:"",commonCommands:[],updatedAt:Date.now()}),n.knownFiles.set(e,t),await this.saveProjectMemory(n)}async setProjectNotes(e){let t=await this.getProjectMemory();t||(t={knownFiles:new Map,projectNotes:"",commonCommands:[],updatedAt:Date.now()}),t.projectNotes=e,await this.saveProjectMemory(t)}async addCommonCommand(e){let t=await this.getProjectMemory();t||(t={knownFiles:new Map,projectNotes:"",commonCommands:[],updatedAt:Date.now()}),t.commonCommands.includes(e)||(t.commonCommands.unshift(e),t.commonCommands=t.commonCommands.slice(0,20),await this.saveProjectMemory(t))}async getContextSummary(){const e=await this.getProjectMemory();if(!e)return"";const t=[];if(e.projectNotes&&t.push(`## Project Notes\n${e.projectNotes}`),e.knownFiles.size>0){const n=Array.from(e.knownFiles.entries()).map(([e,t])=>`- ${e}: ${t}`).join("\n");t.push(`## Known Files\n${n}`)}return e.commonCommands.length>0&&t.push(`## Common Commands\n${e.commonCommands.join(", ")}`),t.length>0?t.join("\n\n"):""}async exportHistory(){const e=await this.getAllSessions(),t=await this.getProjectMemory(),n={exportedAt:(new Date).toISOString(),sessions:e,projectMemory:t?{knownFiles:Object.fromEntries(t.knownFiles),projectNotes:t.projectNotes,commonCommands:t.commonCommands}:null};return JSON.stringify(n,null,2)}async importHistory(e){try{const t=JSON.parse(e);if(t.sessions&&Array.isArray(t.sessions)&&await this.context.workspaceState.update(n,t.sessions),t.projectMemory){const e={knownFiles:new Map(Object.entries(t.projectMemory.knownFiles||{})),projectNotes:t.projectMemory.projectNotes||"",commonCommands:t.projectMemory.commonCommands||[],updatedAt:Date.now()};await this.saveProjectMemory(e)}return{sessions:t.sessions?.length||0,success:!0}}catch{return{sessions:0,success:!1}}}}},265(e,t,n){var o,i=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n);var i=Object.getOwnPropertyDescriptor(t,n);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,o,i)}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),r=this&&this.__importStar||(o=function(e){return o=Object.getOwnPropertyNames||function(e){var t=[];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[t.length]=n);return t},o(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n=o(e),r=0;r<n.length;r++)"default"!==n[r]&&i(t,e,n[r]);return s(t,e),t});Object.defineProperty(t,"__esModule",{value:!0}),t.activate=function(e){console.log("LocalAI extension is now active!"),p=a.window.createStatusBarItem(a.StatusBarAlignment.Left,100),p.name="LocalAI Status",e.subscriptions.push(p),u=new c.MemoryService(e);const t=a.commands.registerCommand("localai.openChat",()=>{l.ChatPanel.createOrShow(e.extensionUri,u)}),n=a.commands.registerCommand("localai.applyEdit",async()=>{const e=a.window.activeTextEditor;let t=e?(0,d.getPendingEditForFile)(e.document.uri.fsPath):void 0;if(!t){const e=(0,d.getAllPendingEdits)();e.length>0&&(t=e[e.length-1])}if(t){const e=await(0,d.applyPendingEdit)(t.id);a.window.showInformationMessage(e),i()}else a.window.showWarningMessage("No pending edit found")}),o=a.commands.registerCommand("localai.rejectEdit",async()=>{const e=a.window.activeTextEditor;let t=e?(0,d.getPendingEditForFile)(e.document.uri.fsPath):void 0;if(!t){const e=(0,d.getAllPendingEdits)();e.length>0&&(t=e[e.length-1])}if(t){const e=await(0,d.rejectPendingEdit)(t.id);a.window.showInformationMessage(e),i()}else a.window.showWarningMessage("No pending edit found")});function i(){const e=(0,d.getPendingEditsCount)()>0;a.commands.executeCommand("setContext","localai.hasPendingEdit",e)}e.subscriptions.push(a.window.onDidChangeActiveTextEditor(()=>{i()})),e.subscriptions.push((0,d.onPendingEditsChanged)(()=>{i()}));const s=a.commands.registerCommand("localai.stopGeneration",()=>{l.ChatPanel.currentPanel&&l.ChatPanel.currentPanel.stopGeneration()});e.subscriptions.push(t,n,o,s)},t.deactivate=function(){l.ChatPanel.currentPanel&&l.ChatPanel.currentPanel.dispose()},t.showGeneratingStatus=function(e){p&&(p.text="$(sync~spin) LocalAI: Generating...",p.tooltip=`Model: ${e}\nClick to stop`,p.backgroundColor=new a.ThemeColor("statusBarItem.warningBackground"),p.command="localai.stopGeneration",p.show())},t.updateGeneratingStatus=function(e){p&&(p.text=`$(sync~spin) LocalAI: ${e}s`,e>=60&&(p.text=`$(warning) LocalAI: ${e}s - slow response`,p.backgroundColor=new a.ThemeColor("statusBarItem.errorBackground")))},t.hideGeneratingStatus=function(){p&&p.hide()},t.showReadyStatus=function(){p&&(p.text="$(check) LocalAI: Ready",p.tooltip="LocalAI is ready",p.backgroundColor=void 0,p.command=void 0,p.show(),setTimeout(()=>{"$(check) LocalAI: Ready"===p.text&&p.hide()},3e3))};const a=r(n(398)),l=n(368),c=n(97),d=n(623);let p,u},317(e){e.exports=require("child_process")},368(e,t,n){var o,i=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n);var i=Object.getOwnPropertyDescriptor(t,n);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,o,i)}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),r=this&&this.__importStar||(o=function(e){return o=Object.getOwnPropertyNames||function(e){var t=[];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[t.length]=n);return t},o(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n=o(e),r=0;r<n.length;r++)"default"!==n[r]&&i(t,e,n[r]);return s(t,e),t});Object.defineProperty(t,"__esModule",{value:!0}),t.ChatPanel=void 0;const a=r(n(398)),l=n(448),c=n(623),d=n(265);class p{static currentPanel;panel;extensionUri;ollama;messages=[];agentModel="";coderModel="";abortController=null;memory;currentSession=null;waitingForApproval=!1;lastPendingCount=0;autoApproveMode=!1;disposables=[];constructor(e,t,n){this.panel=e,this.extensionUri=t,this.ollama=new l.OllamaService,this.memory=n,this.panel.webview.html=this.getHtmlContent(),(0,c.onPendingEditsChanged)(()=>{const e=(0,c.getPendingEditsCount)();this.waitingForApproval&&e<this.lastPendingCount&&(this.waitingForApproval=!1,this.continueAfterApproval()),this.lastPendingCount=e,this.updatePendingEditsCount()}),this.panel.webview.onDidReceiveMessage(async e=>{switch(e.command){case"sendMessage":await this.handleUserMessage(e.text,e.context);break;case"selectAgentModel":this.agentModel=e.model;break;case"selectCoderModel":this.coderModel=e.model;break;case"getModels":await this.sendModelList();break;case"updateApiUrl":this.ollama.setBaseUrl(e.url),await this.sendModelList();break;case"clearChat":this.messages=[],await this.memory.clearCurrentMessages();break;case"newSession":this.messages=[],this.currentSession=await this.memory.createNewSession(this.agentModel);break;case"loadSession":await this.loadSession(e.sessionId);break;case"getSessions":await this.sendSessionList();break;case"deleteSession":await this.memory.deleteSession(e.sessionId),await this.sendSessionList();break;case"stopGeneration":this.stopGeneration();break;case"ready":await this.sendModelList(),await this.initSession(),await this.sendSessionList(),this.currentSession&&this.messages.length>0&&this.panel.webview.postMessage({command:"loadedSession",session:{id:this.currentSession.id,title:this.currentSession.title,model:this.currentSession.model,messageCount:this.messages.length},messages:this.messages.filter(e=>"user"===e.role||"assistant"===e.role)});break;case"approveEdit":const t=await(0,c.applyPendingEdit)(e.editId);this.panel.webview.postMessage({command:"editResult",editId:e.editId,result:t,approved:!0}),this.updatePendingEditsCount(),t.includes("âœ“")&&this.waitingForApproval&&(this.waitingForApproval=!1,await this.continueAfterApproval());break;case"rejectEdit":const n=await(0,c.rejectPendingEdit)(e.editId);this.panel.webview.postMessage({command:"editResult",editId:e.editId,result:n,approved:!1}),this.updatePendingEditsCount();break;case"approveAllEdits":const o=await(0,c.applyAllPendingEdits)();this.panel.webview.postMessage({command:"bulkEditResult",result:o,approved:!0}),this.updatePendingEditsCount();break;case"rejectAllEdits":const i=(0,c.rejectAllPendingEdits)();this.panel.webview.postMessage({command:"bulkEditResult",result:i,approved:!1}),this.updatePendingEditsCount();break;case"setAutoApprove":this.autoApproveMode=e.enabled,this.autoApproveMode&&this.waitingForApproval&&(await(0,c.applyAllPendingEdits)(),this.waitingForApproval=!1,this.updatePendingEditsCount(),await this.continueAfterApproval());break;case"getContext":await this.handleGetContext(e.type,e.value);break;case"openFile":this.openFile(e.path,e.line)}},null,this.disposables),this.panel.onDidDispose(()=>this.dispose(),null,this.disposables)}static createOrShow(e,t){const n=a.ViewColumn.Beside;if(p.currentPanel)return p.currentPanel.panel.reveal(n),p.currentPanel;const o=a.window.createWebviewPanel("localaiChat","LocalAI",n,{enableScripts:!0,retainContextWhenHidden:!0,localResourceRoots:[e]});return p.currentPanel=new p(o,e,t),p.currentPanel}stopGeneration(){this.abortController&&(this.abortController.abort(),this.abortController=null),this.waitingForApproval=!1,(0,d.hideGeneratingStatus)(),this.panel.webview.postMessage({command:"endResponse"})}async initSession(){const e=await this.memory.loadCurrentSession();e?(this.currentSession=e,this.messages=e.messages,this.agentModel=e.model):this.currentSession=await this.memory.createNewSession(this.agentModel)}async loadSession(e){const t=(await this.memory.getAllSessions()).find(t=>t.id===e);t&&(this.currentSession=t,this.messages=t.messages,this.agentModel=t.model,this.panel.webview.postMessage({command:"loadedSession",session:{id:t.id,title:t.title,model:t.model,messageCount:t.messages.length},messages:t.messages.filter(e=>"user"===e.role||"assistant"===e.role)}))}async sendSessionList(){const e=await this.memory.getAllSessions();this.panel.webview.postMessage({command:"sessionList",sessions:e.map(e=>({id:e.id,title:e.title,model:e.model,messageCount:e.messages.length,updatedAt:e.updatedAt})),currentSessionId:this.currentSession?.id})}async saveCurrentSession(){this.currentSession&&(this.currentSession.messages=this.messages,this.currentSession.model=this.agentModel,await this.memory.saveSession(this.currentSession))}updatePendingEditsCount(){this.panel.webview.postMessage({command:"pendingEditsCount",count:(0,c.getPendingEditsCount)()})}async handleGetContext(e,t){let o="";const i=a.workspace.workspaceFolders?.[0]?.uri.fsPath;try{if("special"===e){if("@selection"===t){const e=a.window.activeTextEditor;e&&(o=e.document.getText(e.selection)||"(No text selected)")}else if("@file"===t){const e=a.window.activeTextEditor;e&&(o=`File: ${e.document.fileName}\n${"â”€".repeat(40)}\n${e.document.getText()}`)}else if("@errors"===t){const e=a.window.activeTextEditor;if(e){const t=a.languages.getDiagnostics(e.document.uri);o=t.length>0?t.map(e=>`Line ${e.range.start.line+1}: [${0===e.severity?"Error":"Warning"}] ${e.message}`).join("\n"):"(No errors in current file)"}}}else if("file"===e&&i){const e=t.replace("@file:",""),s=n(928).join(i,e),r=n(896);r.existsSync(s)&&(o=`File: ${e}\n${"â”€".repeat(40)}\n${r.readFileSync(s,"utf-8")}`)}}catch(e){o=`(Error: ${e instanceof Error?e.message:"Unknown"})`}this.panel.webview.postMessage({command:"contextData",value:t,content:o})}async openFile(e,t){const n=a.workspace.workspaceFolders?.[0]?.uri.fsPath;if(!n)return;const o=a.Uri.file(e.startsWith("/")||e.includes(":")?e:`${n}/${e}`);try{const e=await a.workspace.openTextDocument(o),n=await a.window.showTextDocument(e);if(t&&t>0){const e=new a.Position(t-1,0);n.selection=new a.Selection(e,e),n.revealRange(new a.Range(e,e),a.TextEditorRevealType.InCenter)}}catch{a.window.showErrorMessage(`Could not open file: ${e}`)}}async sendModelList(){try{const e=await this.ollama.listModels(),t=["llama3.1","llama3.2","llama3.3","mistral"];e.length>0&&!this.agentModel&&(this.agentModel=e.find(e=>t.some(t=>e.toLowerCase().includes(t)))||e[0]),e.length>0&&!this.coderModel&&(this.coderModel=e.find(e=>e.toLowerCase().includes("coder")||e.toLowerCase().includes("qwen"))||""),this.panel.webview.postMessage({command:"modelList",models:e,agentModel:this.agentModel,coderModel:this.coderModel})}catch(e){this.panel.webview.postMessage({command:"error",text:"Ollama baÄŸlantÄ±sÄ± kurulamadÄ±. ollama serve Ã§alÄ±ÅŸÄ±yor mu?"})}}async handleUserMessage(e,t){let n=e;if(t&&t.length>0){const o=t.filter(e=>e.content).map(e=>`[${e.label}]\n${e.content}`);o.length>0&&(n=`Context:\n${o.join("\n\n")}\n\nUser request: ${e}`)}this.messages.push({role:"user",content:n}),await this.saveCurrentSession(),this.panel.webview.postMessage({command:"addMessage",role:"user",content:e}),this.panel.webview.postMessage({command:"startResponse"});try{await this.runAgentLoop()}catch(e){(0,d.hideGeneratingStatus)(),"AbortError"===e.name?this.panel.webview.postMessage({command:"appendToken",token:"\n\n*[Durduruldu]*"}):this.panel.webview.postMessage({command:"error",text:e instanceof Error?e.message:"Bilinmeyen hata"})}this.waitingForApproval||this.panel.webview.postMessage({command:"endResponse"})}async runAgentLoop(){let e=0,t=null;const n=Date.now();this.abortController=new AbortController;const o=this.agentModel||this.coderModel;if(!o)throw new Error("LÃ¼tfen en az bir model seÃ§in");(0,d.showGeneratingStatus)(o),t=setInterval(()=>{(0,d.updateGeneratingStatus)(Math.floor((Date.now()-n)/1e3))},1e3);try{for(;e<10;){if(this.abortController?.signal.aborted)throw new DOMException("Aborted","AbortError");e++;const n=[{role:"system",content:(0,c.getSystemPrompt)()},...this.messages],i=(0,c.getOllamaTools)(),{content:s,toolCalls:r}=await this.ollama.chatWithTools(o,n,i,e=>{this.panel.webview.postMessage({command:"appendToken",token:e})},this.abortController.signal);if(!(r&&r.length>0)){this.messages.push({role:"assistant",content:s}),await this.saveCurrentSession();break}this.messages.push({role:"assistant",content:s,tool_calls:r}),this.panel.webview.postMessage({command:"endResponse"});for(const e of r){if(this.abortController?.signal.aborted)throw new DOMException("Aborted","AbortError");const n=e.function.name;let o=e.function.arguments;if(["write_file","edit_file"].includes(n)&&this.coderModel&&this.coderModel!==this.agentModel&&(!o.content||o.content.length<50)){this.panel.webview.postMessage({command:"startCodeGeneration",coderModel:this.coderModel});const e=await this.generateCodeWithCoderModel(n,o);e&&(o={...o,content:e}),this.panel.webview.postMessage({command:"endCodeGeneration"})}const i={...o};["write_file","edit_file"].includes(n)&&(i.content&&(i.content=`[${i.content.split("\n").length} satÄ±r]`),i.new_text&&(i.new_text=`[${i.new_text.split("\n").length} satÄ±r]`),i.old_text&&(i.old_text=`[${i.old_text.split("\n").length} satÄ±r]`)),this.panel.webview.postMessage({command:"toolCall",name:n,params:i});const s=await(0,c.executeTool)(n,o);let r=s;if("read_file"===n?r="âœ“ dosya okundu":"write_file"===n?r="âœ“ dosya yazÄ±ldÄ±":"edit_file"===n&&(r="âœ“ dosya dÃ¼zenlendi"),this.panel.webview.postMessage({command:"toolResult",name:n,result:r}),this.messages.push({role:"tool",content:s}),["write_file","edit_file"].includes(n)&&s.includes("PENDING_EDIT")){if(this.autoApproveMode){await(0,c.applyAllPendingEdits)(),this.updatePendingEditsCount(),this.panel.webview.postMessage({command:"toolResult",name:n,result:"âœ“ otomatik onaylandÄ±"});continue}return this.waitingForApproval=!0,this.lastPendingCount=(0,c.getPendingEditsCount)(),this.messages.push({role:"assistant",content:"DeÄŸiÅŸiklikler diff editÃ¶rde. OnaylayÄ±n veya reddedin."}),await this.saveCurrentSession(),t&&clearInterval(t),(0,d.hideGeneratingStatus)(),void this.panel.webview.postMessage({command:"endResponse"})}}this.panel.webview.postMessage({command:"startResponse"})}}finally{t&&clearInterval(t),(0,d.hideGeneratingStatus)(),(0,d.showReadyStatus)(),this.abortController=null}}async generateCodeWithCoderModel(e,t){if(!this.coderModel)return null;const n=this.messages.filter(e=>"user"===e.role),o=n[n.length-1]?.content||"",i="edit_file"===e?`Edit code based on: ${o}\nFile: ${t.path}\nOld text: ${t.old_text}\nProvide ONLY the new code.`:`Generate code for: ${o}\nFile: ${t.path}\nProvide ONLY the file content.`;try{let e=(await this.ollama.chatWithTools(this.coderModel,[{role:"user",content:i}],[],()=>{},this.abortController?.signal)).content.trim();const t=e.match(/```[\w]*\n([\s\S]*?)```/);return t&&(e=t[1].trim()),e}catch{return null}}async continueAfterApproval(){this.messages.push({role:"user",content:"[DeÄŸiÅŸiklikler onaylandÄ±. Devam et.]"}),this.panel.webview.postMessage({command:"startResponse"});try{await this.runAgentLoop()}catch(e){e instanceof DOMException&&"AbortError"===e.name||this.panel.webview.postMessage({command:"error",text:e instanceof Error?e.message:"Hata"})}}getHtmlContent(){return"<!DOCTYPE html>\n<html lang=\"en\">\n<head>\n    <meta charset=\"UTF-8\">\n    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">\n    <title>LocalAI</title>\n    <style>\n        :root {\n            --bg: #1e1e1e;\n            --bg-light: #252526;\n            --bg-lighter: #2d2d2d;\n            --border: #3c3c3c;\n            --text: #d4d4d4;\n            --text-dim: #808080;\n            --green: #4ec957;\n            --cyan: #56b6c2;\n            --yellow: #e5c07b;\n            --red: #e06c75;\n        }\n        * { box-sizing: border-box; margin: 0; padding: 0; }\n        body {\n            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;\n            background: var(--bg);\n            color: var(--text);\n            height: 100vh;\n            display: flex;\n            flex-direction: column;\n            font-size: 13px;\n        }\n        /* Header */\n        .header {\n            padding: 8px 12px;\n            background: var(--bg-light);\n            border-bottom: 1px solid var(--border);\n            display: flex;\n            gap: 8px;\n            align-items: center;\n            flex-wrap: wrap;\n        }\n        .header input, .header select {\n            background: var(--bg-lighter);\n            color: var(--text);\n            border: 1px solid var(--border);\n            padding: 4px 8px;\n            border-radius: 4px;\n            font-size: 12px;\n        }\n        .header input { flex: 1; min-width: 120px; }\n        .header select { min-width: 100px; }\n        .header button {\n            background: var(--bg-lighter);\n            color: var(--cyan);\n            border: 1px solid var(--border);\n            padding: 4px 12px;\n            border-radius: 4px;\n            cursor: pointer;\n            font-size: 12px;\n        }\n        .header button:hover { background: var(--border); }\n        .model-row {\n            display: flex;\n            gap: 8px;\n            align-items: center;\n            width: 100%;\n        }\n        .model-label { font-size: 10px; color: var(--cyan); font-weight: bold; }\n        /* Chat */\n        .chat-container {\n            flex: 1;\n            overflow-y: auto;\n            padding: 16px 16px 16px 24px;\n        }\n        .timeline {\n            border-left: 2px solid var(--border);\n            margin-left: 6px;\n            padding-left: 20px;\n        }\n        .timeline-item {\n            position: relative;\n            padding-bottom: 16px;\n        }\n        .timeline-item:last-child { padding-bottom: 24px; }\n        .timeline-dot {\n            position: absolute;\n            left: -27px;\n            top: 4px;\n            width: 10px;\n            height: 10px;\n            border-radius: 50%;\n            background: var(--bg);\n            border: 2px solid var(--text-dim);\n        }\n        .timeline-item.user .timeline-dot {\n            border-color: var(--green);\n            background: var(--green);\n        }\n        .timeline-item.assistant .timeline-dot {\n            border-color: var(--cyan);\n        }\n        .timeline-item.assistant.complete .timeline-dot {\n            background: var(--cyan);\n        }\n        .timeline-item.generating .timeline-dot {\n            background: var(--cyan);\n            animation: pulse 1s ease-in-out infinite;\n        }\n        @keyframes pulse {\n            0%, 100% { opacity: 1; }\n            50% { opacity: 0.3; }\n        }\n        .timeline-item.tool .timeline-dot {\n            width: 6px; height: 6px;\n            left: -25px; top: 6px;\n            border-color: var(--yellow);\n            background: var(--yellow);\n        }\n        .timeline-item.error .timeline-dot {\n            border-color: var(--red);\n            background: var(--red);\n        }\n        .timeline-header {\n            display: flex;\n            align-items: center;\n            gap: 8px;\n            margin-bottom: 4px;\n            font-size: 11px;\n        }\n        .timeline-sender { font-weight: 600; }\n        .timeline-item.user .timeline-sender { color: var(--green); }\n        .timeline-item.assistant .timeline-sender { color: var(--cyan); }\n        .timeline-time { color: var(--text-dim); font-size: 10px; }\n        .elapsed-time { color: var(--text-dim); font-size: 10px; }\n        .elapsed-time.warning { color: var(--yellow); }\n        .timeline-content {\n            background: var(--bg-light);\n            border: 1px solid var(--border);\n            border-radius: 6px;\n            padding: 10px 14px;\n            line-height: 1.5;\n            white-space: pre-wrap;\n            word-break: break-word;\n        }\n        .timeline-item.user .timeline-content {\n            background: #1a2e1a;\n            border-color: #2d4a2d;\n        }\n        .timeline-item.error .timeline-content {\n            background: #2e1a1a;\n            border-color: #4a2d2d;\n            color: var(--red);\n        }\n        .timeline-item.tool .timeline-content {\n            background: transparent;\n            border: none;\n            padding: 0;\n            font-size: 12px;\n            color: var(--text-dim);\n        }\n        .timeline-item.tool { padding-bottom: 8px; }\n        .generating-content {\n            background: transparent !important;\n            border: none !important;\n            padding: 0 !important;\n        }\n        .generating-dots {\n            display: inline-flex;\n            gap: 3px;\n        }\n        .generating-dots span {\n            width: 5px; height: 5px;\n            background: var(--cyan);\n            border-radius: 50%;\n            animation: wave 1.2s ease-in-out infinite;\n        }\n        .generating-dots span:nth-child(2) { animation-delay: 0.15s; }\n        .generating-dots span:nth-child(3) { animation-delay: 0.3s; }\n        @keyframes wave {\n            0%, 60%, 100% { transform: scale(0.6); opacity: 0.4; }\n            30% { transform: scale(1); opacity: 1; }\n        }\n        .tool-action { color: var(--cyan); }\n        /* Code */\n        pre {\n            background: var(--bg);\n            padding: 10px;\n            border-radius: 4px;\n            overflow-x: auto;\n            margin: 8px 0;\n        }\n        code {\n            font-family: 'Fira Code', Consolas, monospace;\n            font-size: 12px;\n        }\n        /* Input */\n        .input-section {\n            padding: 12px;\n            background: var(--bg);\n            border-top: 1px solid var(--border);\n        }\n        .input-wrapper {\n            display: flex;\n            background: var(--bg-lighter);\n            border: 1px solid var(--border);\n            border-radius: 8px;\n            padding: 8px 12px;\n            gap: 8px;\n            align-items: flex-end;\n        }\n        .input-wrapper:focus-within {\n            border-color: var(--cyan);\n        }\n        .input-section textarea {\n            flex: 1;\n            background: transparent;\n            color: var(--text);\n            border: none;\n            outline: none;\n            font-family: inherit;\n            font-size: 13px;\n            resize: none;\n            min-height: 24px;\n            max-height: 150px;\n        }\n        .input-actions {\n            display: flex;\n            gap: 4px;\n        }\n        .input-actions button {\n            background: transparent;\n            border: none;\n            padding: 4px 8px;\n            cursor: pointer;\n            border-radius: 4px;\n            font-size: 14px;\n        }\n        .input-actions button.stop { color: var(--red); }\n        .input-actions button.send { color: var(--green); }\n        .input-actions button:hover { background: var(--border); }\n        /* Auto-approve toggle */\n        .auto-approve-row {\n            display: flex;\n            align-items: center;\n            gap: 8px;\n            padding: 6px 12px;\n            background: var(--bg-light);\n            border-top: 1px solid var(--border);\n            font-size: 11px;\n        }\n        .auto-approve-row label {\n            display: flex;\n            align-items: center;\n            gap: 6px;\n            cursor: pointer;\n            color: var(--text-dim);\n        }\n        .auto-approve-row input[type=\"checkbox\"] {\n            width: 14px;\n            height: 14px;\n            cursor: pointer;\n        }\n        .auto-approve-row.active label {\n            color: var(--yellow);\n        }\n        .auto-approve-hint {\n            font-size: 10px;\n            color: var(--text-dim);\n            margin-left: auto;\n        }\n    </style>\n</head>\n<body>\n    <div class=\"header\">\n        <input type=\"text\" id=\"apiUrl\" value=\"http://localhost:11434\" placeholder=\"Ollama URL\">\n        <button id=\"fetchBtn\">Fetch</button>\n        <button id=\"newBtn\">New</button>\n        <button id=\"historyBtn\">History</button>\n    </div>\n    <div class=\"header model-row\">\n        <span class=\"model-label\">AGENT:</span>\n        <select id=\"agentModel\"><option>Loading...</option></select>\n        <span class=\"model-label\">CODER:</span>\n        <select id=\"coderModel\"><option>Optional</option></select>\n    </div>\n    <div class=\"chat-container\" id=\"chatContainer\">\n        <div class=\"timeline\" id=\"chat\">\n            <div class=\"timeline-item assistant complete\">\n                <div class=\"timeline-dot\"></div>\n                <div class=\"timeline-content\">LocalAI ready. How can I help?</div>\n            </div>\n        </div>\n    </div>\n    <div class=\"auto-approve-row\" id=\"autoApproveRow\">\n        <label>\n            <input type=\"checkbox\" id=\"autoApproveToggle\">\n            <span>Auto-approve edits</span>\n        </label>\n        <span class=\"auto-approve-hint\">Skip diff review for this session</span>\n    </div>\n    <div class=\"input-section\">\n        <div class=\"input-wrapper\">\n            <textarea id=\"input\" rows=\"1\" placeholder=\"Ask anything... (Shift+Enter for new line)\"></textarea>\n            <div class=\"input-actions\">\n                <button id=\"stopBtn\" class=\"stop\" style=\"display:none\">â– </button>\n                <button id=\"sendBtn\" class=\"send\">â†µ</button>\n            </div>\n        </div>\n    </div>\n    <script>\n        const vscode = acquireVsCodeApi();\n        const chat = document.getElementById('chat');\n        const chatContainer = document.getElementById('chatContainer');\n        const input = document.getElementById('input');\n        const stopBtn = document.getElementById('stopBtn');\n        const sendBtn = document.getElementById('sendBtn');\n        const agentModel = document.getElementById('agentModel');\n        const coderModel = document.getElementById('coderModel');\n        const apiUrl = document.getElementById('apiUrl');\n        const fetchBtn = document.getElementById('fetchBtn');\n        const newBtn = document.getElementById('newBtn');\n        const autoApproveToggle = document.getElementById('autoApproveToggle');\n        const autoApproveRow = document.getElementById('autoApproveRow');\n\n        let currentLine = null;\n        let isResponding = false;\n\n        fetchBtn.onclick = () => vscode.postMessage({ command: 'updateApiUrl', url: apiUrl.value.trim() });\n        newBtn.onclick = () => {\n            vscode.postMessage({ command: 'newSession' });\n            chat.innerHTML = '<div class=\"timeline-item assistant complete\"><div class=\"timeline-dot\"></div><div class=\"timeline-content\">New session started.</div></div>';\n            // Reset auto-approve on new session\n            autoApproveToggle.checked = false;\n            autoApproveRow.classList.remove('active');\n            vscode.postMessage({ command: 'setAutoApprove', enabled: false });\n        };\n        autoApproveToggle.onchange = () => {\n            const enabled = autoApproveToggle.checked;\n            autoApproveRow.classList.toggle('active', enabled);\n            vscode.postMessage({ command: 'setAutoApprove', enabled });\n        };\n        stopBtn.onclick = () => vscode.postMessage({ command: 'stopGeneration' });\n        sendBtn.onclick = send;\n        agentModel.onchange = () => vscode.postMessage({ command: 'selectAgentModel', model: agentModel.value });\n        coderModel.onchange = () => vscode.postMessage({ command: 'selectCoderModel', model: coderModel.value });\n\n        input.onkeydown = (e) => {\n            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); }\n        };\n        input.oninput = () => {\n            input.style.height = 'auto';\n            input.style.height = Math.min(input.scrollHeight, 150) + 'px';\n        };\n\n        function send() {\n            const text = input.value.trim();\n            if (!text || isResponding) return;\n            vscode.postMessage({ command: 'sendMessage', text });\n            input.value = '';\n            input.style.height = 'auto';\n        }\n\n        function addLine(cls, content, isHtml) {\n            const item = document.createElement('div');\n            item.className = 'timeline-item ' + cls + (cls === 'assistant' ? ' complete' : '');\n\n            const dot = document.createElement('div');\n            dot.className = 'timeline-dot';\n\n            if (cls === 'user' || cls === 'assistant' || cls === 'error') {\n                const header = document.createElement('div');\n                header.className = 'timeline-header';\n                const sender = document.createElement('span');\n                sender.className = 'timeline-sender';\n                sender.textContent = cls === 'user' ? 'You' : cls === 'error' ? 'Error' : 'LocalAI';\n                const time = document.createElement('span');\n                time.className = 'timeline-time';\n                time.textContent = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});\n                header.appendChild(sender);\n                header.appendChild(time);\n                item.appendChild(dot);\n                item.appendChild(header);\n            } else {\n                item.appendChild(dot);\n            }\n\n            const contentDiv = document.createElement('div');\n            contentDiv.className = 'timeline-content';\n            if (isHtml) contentDiv.innerHTML = content;\n            else contentDiv.textContent = content;\n            item.appendChild(contentDiv);\n\n            chat.appendChild(item);\n            chatContainer.scrollTop = chatContainer.scrollHeight;\n            return contentDiv;\n        }\n\n        function escapeHtml(t) { return t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }\n        function renderMd(text) {\n            text = text.replace(/```(\\w*)\\n?([\\s\\S]*?)```/g, (m,l,c) => '<pre><code>' + escapeHtml(c.trim()) + '</code></pre>');\n            text = text.replace(/`([^`]+)`/g, '<code>$1</code>');\n            text = text.replace(/\\*\\*([^*]+)\\*\\*/g, '<strong>$1</strong>');\n            text = text.replace(/\\n/g, '<br>');\n            return text;\n        }\n\n        window.onmessage = (e) => {\n            const msg = e.data;\n            switch(msg.command) {\n                case 'modelList':\n                    agentModel.innerHTML = msg.models.map(m => '<option value=\"'+m+'\"'+(m===msg.agentModel?' selected':'')+'>'+m+'</option>').join('');\n                    coderModel.innerHTML = '<option value=\"\">None</option>' + msg.models.map(m => '<option value=\"'+m+'\"'+(m===msg.coderModel?' selected':'')+'>'+m+'</option>').join('');\n                    break;\n                case 'addMessage':\n                    addLine(msg.role, msg.content);\n                    break;\n                case 'startResponse':\n                    isResponding = true;\n                    stopBtn.style.display = 'inline';\n\n                    var item = document.createElement('div');\n                    item.className = 'timeline-item assistant generating';\n                    item.id = 'current-response';\n\n                    var dot = document.createElement('div');\n                    dot.className = 'timeline-dot';\n\n                    var header = document.createElement('div');\n                    header.className = 'timeline-header';\n                    header.style.display = 'none';\n                    header.innerHTML = '<span class=\"timeline-sender\">LocalAI</span><span class=\"timeline-time\">' + new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) + '</span>';\n\n                    currentLine = document.createElement('div');\n                    currentLine.className = 'timeline-content generating-content';\n                    currentLine._raw = '';\n\n                    item.appendChild(dot);\n                    item.appendChild(header);\n                    item.appendChild(currentLine);\n                    chat.appendChild(item);\n                    chatContainer.scrollTop = chatContainer.scrollHeight;\n                    break;\n                case 'appendToken':\n                    if (currentLine) {\n                        if (currentLine.classList.contains('generating-content')) {\n                            currentLine.classList.remove('generating-content');\n                            var container = document.getElementById('current-response');\n                            if (container) {\n                                var hdr = container.querySelector('.timeline-header');\n                                if (hdr) hdr.style.display = 'flex';\n                            }\n                        }\n                        currentLine._raw += msg.token;\n                        currentLine.innerHTML = renderMd(currentLine._raw) + '<span class=\"generating-dots\"><span></span><span></span><span></span></span>';\n                        chatContainer.scrollTop = chatContainer.scrollHeight;\n                    }\n                    break;\n                case 'endResponse':\n                    var container = document.getElementById('current-response');\n                    if (currentLine && currentLine._raw && currentLine._raw.trim()) {\n                        currentLine.innerHTML = renderMd(currentLine._raw);\n                        if (container) {\n                            container.classList.remove('generating');\n                            container.classList.add('complete');\n                        }\n                    } else if (container) {\n                        container.remove();\n                    }\n                    if (container) container.removeAttribute('id');\n                    isResponding = false;\n                    stopBtn.style.display = 'none';\n                    currentLine = null;\n                    break;\n                case 'toolCall':\n                    var toolDesc = {'read_file':'ðŸ“– Reading','write_file':'ðŸ“ Writing','edit_file':'âœï¸ Editing','list_files':'ðŸ“ Listing','search_files':'ðŸ” Searching','run_terminal_command':'ðŸ’» Running'}[msg.name] || 'ðŸ”§ ' + msg.name;\n                    var detail = msg.params?.path || msg.params?.pattern || msg.params?.command || '';\n                    if (detail.length > 40) detail = detail.substring(0,40) + '...';\n                    addLine('tool', '<span class=\"tool-action\">' + toolDesc + '</span>' + (detail ? ': ' + escapeHtml(detail) : ''), true);\n                    break;\n                case 'toolResult':\n                    break;\n                case 'error':\n                    isResponding = false;\n                    stopBtn.style.display = 'none';\n                    var container = document.getElementById('current-response');\n                    if (container) container.remove();\n                    currentLine = null;\n                    addLine('error', msg.text);\n                    break;\n            }\n        };\n\n        setTimeout(() => vscode.postMessage({ command: 'ready' }), 300);\n    <\/script>\n</body>\n</html>"}dispose(){for(p.currentPanel=void 0,this.panel.dispose();this.disposables.length;){const e=this.disposables.pop();e&&e.dispose()}}}t.ChatPanel=p},398(e){e.exports=require("vscode")},448(e,t,n){var o,i=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n);var i=Object.getOwnPropertyDescriptor(t,n);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,o,i)}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),r=this&&this.__importStar||(o=function(e){return o=Object.getOwnPropertyNames||function(e){var t=[];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[t.length]=n);return t},o(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n=o(e),r=0;r<n.length;r++)"default"!==n[r]&&i(t,e,n[r]);return s(t,e),t});Object.defineProperty(t,"__esModule",{value:!0}),t.OllamaService=void 0;const a=r(n(398));t.OllamaService=class{baseUrl;constructor(){this.baseUrl=this.getBaseUrl()}getBaseUrl(){return a.workspace.getConfiguration("localai").get("ollamaUrl")||"http://localhost:11434"}updateBaseUrl(){this.baseUrl=this.getBaseUrl()}setBaseUrl(e){this.baseUrl=e}getCurrentUrl(){return this.baseUrl}async chatWithTools(e,t,n,o,i){const s=`${this.baseUrl}/api/chat`,r=0===n.length,a={model:e,messages:t,tools:n.length>0?n:void 0,stream:r};console.log("[LocalAI] Chat request:",{url:s,model:e,messageCount:t.length,toolCount:n.length,toolNames:n.map(e=>e.function.name)});let l=null;for(let e=1;e<=3;e++)try{const t=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a),signal:i});if(!t.ok){if(500===t.status&&e<3){console.log(`[LocalAI] 500 error, retrying in ${3*e}s... (attempt ${e}/3)`),await new Promise(t=>setTimeout(t,3e3*e));continue}throw new Error(`Ollama API error: ${t.status} ${t.statusText}`)}return await this.processResponse(t,r,o)}catch(t){if(l=t,t instanceof DOMException&&"AbortError"===t.name)throw t;if(e<3){console.log(`[LocalAI] Request failed, retrying in ${3*e}s... (attempt ${e}/3):`,t),await new Promise(t=>setTimeout(t,3e3*e));continue}}throw l||new Error("Request failed after retries")}async processResponse(e,t,n){let o="",i=[];if(t){if(!e.body)throw new Error("No response body");const t=e.body.getReader(),s=new TextDecoder;for(;;){const{done:e,value:r}=await t.read();if(e)break;const a=s.decode(r,{stream:!0}).split("\n").filter(e=>e.trim());for(const e of a)try{const t=JSON.parse(e);t.message?.content&&(o+=t.message.content,n?.(t.message.content)),t.message?.tool_calls&&(console.log("[LocalAI] Tool calls received:",JSON.stringify(t.message.tool_calls)),i=t.message.tool_calls)}catch{}}}else{const t=await e.json();if(console.log("[LocalAI] Non-streaming response:",JSON.stringify(t,null,2)),t.message?.content&&(o=t.message.content,n?.(t.message.content)),t.message?.tool_calls&&(console.log("[LocalAI] Tool calls received:",JSON.stringify(t.message.tool_calls)),i=t.message.tool_calls),0===i.length&&o){const e=this.parseToolCallsFromContent(o);e.length>0&&(console.log("[LocalAI] Parsed tool calls from content:",JSON.stringify(e)),i=e,o="")}}return console.log("[LocalAI] Chat response:",{contentLength:o.length,toolCallCount:i.length,toolCalls:i.map(e=>e.function?.name)}),{content:o,toolCalls:i}}async chat(e,t,n){return(await this.chatWithTools(e,t,[],n)).content}async listModels(){const e=`${this.baseUrl}/api/tags`;console.log("[LocalAI] Fetching models from:",e);try{const t=await fetch(e);if(console.log("[LocalAI] Response status:",t.status),!t.ok)throw new Error(`Failed to list models: ${t.status}`);const n=await t.json();return console.log("[LocalAI] Models data:",n),n.models?.map(e=>e.name)||[]}catch(e){throw console.error("[LocalAI] Fetch error:",e),e}}async isAvailable(){try{return(await fetch(`${this.baseUrl}/api/tags`)).ok}catch{return!1}}parseToolCallsFromContent(e){const t=[],n=e=>{const t=e.name,n=e.arguments||e.parameters;return t&&n&&"object"==typeof n?{function:{name:t,arguments:n}}:null};try{const o=e.match(/```(?:json)?\s*([\s\S]*?)```/);if(o){const e=JSON.parse(o[1].trim());if(Array.isArray(e))for(const o of e){const e=n(o);e&&t.push(e)}else{const o=n(e);o&&t.push(o)}if(t.length>0)return t}const i=e.match(/\{[\s\S]*"name"\s*:\s*"(\w+)"[\s\S]*\}/);if(i)try{const e=n(JSON.parse(i[0]));if(e&&t.push(e),t.length>0)return t}catch{}const s=e.trim();if(s.startsWith("{")||s.startsWith("[")){const e=JSON.parse(s);if(Array.isArray(e))for(const o of e){const e=n(o);e&&t.push(e)}else{const o=n(e);o&&t.push(o)}}}catch{}return t}}},623(e,t,n){var o,i=this&&this.__createBinding||(Object.create?function(e,t,n,o){void 0===o&&(o=n);var i=Object.getOwnPropertyDescriptor(t,n);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[n]}}),Object.defineProperty(e,o,i)}:function(e,t,n,o){void 0===o&&(o=n),e[o]=t[n]}),s=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),r=this&&this.__importStar||(o=function(e){return o=Object.getOwnPropertyNames||function(e){var t=[];for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[t.length]=n);return t},o(e)},function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var n=o(e),r=0;r<n.length;r++)"default"!==n[r]&&i(t,e,n[r]);return s(t,e),t});Object.defineProperty(t,"__esModule",{value:!0}),t.tools=void 0,t.onPendingEditsChanged=function(e){return p.push(e),new a.Disposable(()=>{const t=p.indexOf(e);t>=0&&p.splice(t,1)})},t.getPendingEdit=function(e){return d.get(e)},t.getPendingEditForFile=function(e){const t=l.join(n(857).tmpdir(),"localai-diff");if(e.startsWith(t)){const t=l.basename(e).match(/^(edit_\d+_\w+)_/);if(t)return d.get(t[1])}for(const t of d.values())if(t.filePath===e)return t},t.clearPendingEdit=function(e){d.delete(e),u()},t.applyPendingEdit=async function(e){const t=d.get(e);if(!t)return"Error: Edit not found or already applied";try{c.writeFileSync(t.filePath,t.newContent,"utf-8");const n=await a.workspace.openTextDocument(t.filePath);return await a.window.showTextDocument(n,{preview:!1}),d.delete(e),f(e),await w(e),u(),`âœ“ Applied changes to ${t.relativePath}`}catch(e){return`Error: ${e instanceof Error?e.message:"Could not apply edit"}`}},t.rejectPendingEdit=async function(e){const t=d.get(e);return t?(d.delete(e),f(e),await w(e),u(),`âœ— Rejected changes to ${t.relativePath}`):"Edit not found"},t.getAllPendingEdits=m,t.applyAllPendingEdits=async function(){const e=m();if(0===e.length)return"No pending edits to apply";const t=[];for(const n of e)try{c.writeFileSync(n.filePath,n.newContent,"utf-8"),d.delete(n.id),f(n.id),await w(n.id),t.push(`âœ“ ${n.relativePath}`)}catch(e){t.push(`âœ— ${n.relativePath}: ${e instanceof Error?e.message:"Failed"}`)}return`Applied ${t.filter(e=>e.startsWith("âœ“")).length}/${e.length} edits:\n${t.join("\n")}`},t.rejectAllPendingEdits=async function(){const e=m(),t=e.length;for(const t of e)f(t.id),await w(t.id);return d.clear(),`âœ— Rejected ${t} pending edit(s)`},t.getPendingEditsCount=function(){return d.size},t.getOllamaTools=function(){return t.tools.map(e=>({type:"function",function:{name:e.name,description:e.description,parameters:e.parameters}}))},t.getSystemPrompt=function(){return'Sen bir kod yazma asistanÄ±sÄ±n. KullanÄ±cÄ±nÄ±n istediÄŸi uygulamayÄ± TAMAMEN oluÅŸturmalÄ±sÄ±n.\n\n## DAVRANIÅžIN:\n1. KullanÄ±cÄ± bir ÅŸey istediÄŸinde, HEMEN tool kullanarak dosya oluÅŸtur\n2. YarÄ±da bÄ±rakma - tÃ¼m dosyalarÄ± oluÅŸturana kadar devam et\n3. Geri bildirim bekleme - dosyalarÄ± oluÅŸtur ve devam et\n4. Her zaman write_file tool\'unu kullan, sadece aÃ§Ä±klama yazma\n\n## TOOL KULLANIMI:\n\n### Yeni dosya oluÅŸturmak iÃ§in:\nwrite_file tool\'unu Ã§aÄŸÄ±r:\n- path: dosya yolu (Ã¶rn: "src/App.tsx")\n- content: dosyanÄ±n tam iÃ§eriÄŸi\n\n### Var olan dosyayÄ± dÃ¼zenlemek iÃ§in:\n1. Ã–NCE read_file ile dosyayÄ± oku\n2. SONRA edit_file ile deÄŸiÅŸtir (old_text birebir aynÄ± olmalÄ±)\n\n### Proje yapÄ±sÄ±nÄ± gÃ¶rmek iÃ§in:\nlist_files tool\'unu kullan\n\n### Komut Ã§alÄ±ÅŸtÄ±rmak iÃ§in:\nrun_terminal_command tool\'unu kullan\n\n## Ã–NEMLÄ°:\n- Her istekte EN AZ BÄ°R tool Ã§aÄŸÄ±r\n- Sadece metin yazma, tool kullan!\n- Dosya oluÅŸturmak iÃ§in write_file KULLANMALISIN\n\n## Ã–RNEK:\nKullanÄ±cÄ±: "React todo app yap"\n\nYapman gereken:\n1. write_file(path="src/App.jsx", content="import React...")\n2. write_file(path="src/components/TodoList.jsx", content="...")\n3. write_file(path="src/App.css", content="...")\n\nSADECE METÄ°N YAZMA - TOOL KULLAN!'},t.executeTool=async function(e,n){const o=t.tools.find(t=>t.name===e);return o?await o.execute(n):`Unknown tool: ${e}`};const a=r(n(398)),l=r(n(928)),c=r(n(896));let d=new Map;const p=[];function u(){p.forEach(e=>e())}function m(){return Array.from(d.values())}const h=l.join(n(857).tmpdir(),"localai-diff");async function g(e,t,n,o,i){c.existsSync(h)||c.mkdirSync(h,{recursive:!0});const s=l.join(h,`${e}_original${l.extname(t)}`),r=l.join(h,`${e}_modified${l.extname(t)}`);c.writeFileSync(s,o,"utf-8"),c.writeFileSync(r,i,"utf-8");const d=a.Uri.file(s),p=a.Uri.file(r);await a.commands.executeCommand("vscode.diff",d,p,`${n} (Proposed Changes - ${e.slice(-6)})`)}function f(e){try{c.readdirSync(h).filter(t=>t.startsWith(e)).forEach(e=>{c.unlinkSync(l.join(h,e))})}catch{}}async function w(e){const t=a.window.tabGroups.all.flatMap(e=>e.tabs);for(const n of t)n.label.includes(e.slice(-6))&&n.input&&await a.window.tabGroups.close(n)}function y(e,t,n){const o=e.split("\n"),i=t.split("\n");let s=0,r=0;const a=Math.max(o.length,i.length);for(let e=0;e<a;e++)o[e]!==i[e]&&(void 0!==o[e]&&r++,void 0!==i[e]&&s++);return`ðŸ“ ${n}: +${s} -${r} lines`}function v(e){const t={...e};return t.path||(t.path=e.file_path||e.filepath||e.file||e.filename||e.name||""),t.content||(t.content=e.code||e.text||e.data||e.body||""),t.old_text||(t.old_text=e.oldText||e.old||e.find||e.search||e.original||""),t.new_text||(t.new_text=e.newText||e.new||e.replace||e.replacement||""),t.command||(t.command=e.cmd||e.shell||e.exec||""),t.pattern||(t.pattern=e.query||e.search||e.regex||""),t}t.tools=[{name:"read_file",description:"Read the contents of a file. Use this to understand code before making changes.",parameters:{type:"object",properties:{path:{type:"string",description:"File path relative to project root"},start_line:{type:"string",description:"Optional: starting line number (1-indexed)"},end_line:{type:"string",description:"Optional: ending line number (1-indexed)"}},required:["path"]},execute:async e=>{const t=v(e);if(!t.path)return"Error: path parameter is required. Received: "+JSON.stringify(e);const n=a.workspace.workspaceFolders?.[0]?.uri.fsPath;if(!n)return"Error: No workspace folder open";const o=l.join(n,t.path);try{const e=c.readFileSync(o,"utf-8").split("\n"),n=t.start_line?parseInt(t.start_line)-1:0,i=t.end_line?parseInt(t.end_line):e.length,s=e.slice(n,i).map((e,t)=>`${(n+t+1).toString().padStart(4)}: ${e}`);return`File: ${t.path}\n${"â”€".repeat(50)}\n${s.join("\n")}`}catch(e){return`Error: ${e instanceof Error?e.message:"Could not read file"}`}}},{name:"write_file",description:"Create a new file or completely overwrite an existing file. Shows diff preview for user approval.",parameters:{type:"object",properties:{path:{type:"string",description:"File path relative to project root"},content:{type:"string",description:"Complete file content to write"}},required:["path","content"]},execute:async e=>{const t=v(e);if(!t.path)return"Error: path parameter is required. Received: "+JSON.stringify(e);if(!t.content)return"Error: content parameter is required. Received: "+JSON.stringify(e);const n=a.workspace.workspaceFolders?.[0]?.uri.fsPath;if(!n)return"Error: No workspace folder open";const o=l.join(n,t.path);try{const e=l.dirname(o);c.existsSync(e)||c.mkdirSync(e,{recursive:!0});const n=c.existsSync(o)?c.readFileSync(o,"utf-8"):"",i=t.content,s=`edit_${Date.now()}_${Math.random().toString(36).substring(2,11)}`,r={id:s,filePath:o,relativePath:t.path,oldContent:n,newContent:i,oldText:n,newText:i,timestamp:Date.now()};return d.set(s,r),u(),await g(s,o,t.path,n,i),`PENDING_EDIT:${s}\n${""===n?`ðŸ“„ New file: ${t.path} (${i.split("\n").length} lines)`:y(n,i,t.path)}\n\nðŸ‘† VSCode diff editor aÃ§Ä±ldÄ±. DeÄŸiÅŸiklikleri inceleyin.`}catch(e){return`Error: ${e instanceof Error?e.message:"Could not write file"}`}}},{name:"edit_file",description:"Replace text in a file. Shows diff preview for user approval before applying changes.",parameters:{type:"object",properties:{path:{type:"string",description:"File path relative to project root"},old_text:{type:"string",description:"Exact text to find (must match exactly including whitespace)"},new_text:{type:"string",description:"New text to replace with"}},required:["path","old_text","new_text"]},execute:async e=>{const t=v(e);if(!t.path)return"Error: path parameter is required. Received: "+JSON.stringify(e);if(!t.old_text)return"Error: old_text parameter is required. Received: "+JSON.stringify(e);if(!t.new_text&&""!==t.new_text)return"Error: new_text parameter is required. Received: "+JSON.stringify(e);const n=a.workspace.workspaceFolders?.[0]?.uri.fsPath;if(!n)return"Error: No workspace folder open";const o=l.join(n,t.path);if(!c.existsSync(o)){const e=c.readdirSync(n),o=e.filter(e=>e.includes(t.path.replace(/^\.\//,"").split("/").pop()||""));return`Error: File not found: ${t.path}\n\nFiles in project root:\n${e.slice(0,20).map(e=>"  "+e).join("\n")}${o.length>0?"\n\nDid you mean: "+o.join(", "):""}`}try{const e=c.readFileSync(o,"utf-8");if(!e.includes(t.old_text)){const n=e.split("\n"),o=n.slice(0,30).map((e,t)=>`${t+1}: ${e}`).join("\n");return`Error: old_text not found in file.\n\nActual content of ${t.path}:\n${"â”€".repeat(40)}\n${o}${n.length>30?"\n... ("+(n.length-30)+" more lines)":""}\n${"â”€".repeat(40)}\n\nCopy the EXACT text you want to replace from above.`}const n=e.replace(t.old_text,t.new_text),i=`edit_${Date.now()}_${Math.random().toString(36).substring(2,11)}`,s={id:i,filePath:o,relativePath:t.path,oldContent:e,newContent:n,oldText:t.old_text,newText:t.new_text,timestamp:Date.now()};return d.set(i,s),u(),await g(i,o,t.path,e,n),`PENDING_EDIT:${i}\n${y(e,n,t.path)}\n\nðŸ‘† VSCode diff editor aÃ§Ä±ldÄ±. DeÄŸiÅŸiklikleri inceleyin.`}catch(e){return`Error: ${e instanceof Error?e.message:"Could not edit file"}`}}},{name:"list_files",description:"List files and folders in a directory. Use to explore project structure.",parameters:{type:"object",properties:{path:{type:"string",description:'Directory path relative to project root (use "." for root)'},recursive:{type:"string",description:'Set to "true" to list recursively (max 3 levels)'}},required:["path"]},execute:async e=>{const t=v(e),n=a.workspace.workspaceFolders?.[0]?.uri.fsPath;if(!n)return"Error: No workspace folder open";const o=l.join(n,t.path||"."),i="true"===t.recursive,s=["node_modules",".git","dist","out",".vscode","__pycache__","venv"];try{const e=function e(t,n="",o=0){if(o>3)return[];const r=c.readdirSync(t,{withFileTypes:!0}),a=[];for(const c of r){if(c.name.startsWith(".")&&".env"!==c.name)continue;if(s.includes(c.name))continue;const r=c.isDirectory();if(a.push(`${n}${r?"ðŸ“ ":"ðŸ“„ "}${c.name}`),r&&i){const i=l.join(t,c.name);a.push(...e(i,n+"  ",o+1))}}return a}(o);return e.length>0?e.join("\n"):"Empty directory"}catch(e){return`Error: ${e instanceof Error?e.message:"Could not list directory"}`}}},{name:"grep",description:"Search for text/pattern in files. Returns matching lines with file paths and line numbers.",parameters:{type:"object",properties:{pattern:{type:"string",description:"Text or regex pattern to search for"},path:{type:"string",description:"Directory to search in (default: project root)"},file_pattern:{type:"string",description:'File glob pattern like "*.ts" or "*.py" (default: all files)'}},required:["pattern"]},execute:async e=>{const t=v(e);if(!t.pattern)return"Error: pattern parameter is required. Received: "+JSON.stringify(e);const n=a.workspace.workspaceFolders?.[0]?.uri.fsPath;if(!n)return"Error: No workspace folder open";const o=t.path?l.join(n,t.path):n,i=(t.file_pattern,[]),s=["node_modules",".git","dist","out","__pycache__"];try{return function e(o){if(i.length>=50)return;const r=c.readdirSync(o,{withFileTypes:!0});for(const a of r){if(i.length>=50)break;if(s.includes(a.name))continue;if(a.name.startsWith("."))continue;const r=l.join(o,a.name);if(a.isDirectory())e(r);else if(a.isFile()){if(t.file_pattern){const e=t.file_pattern.replace("*","");if(!a.name.endsWith(e))continue}try{const e=c.readFileSync(r,"utf-8").split("\n"),o=new RegExp(t.pattern,"gi");e.forEach((e,t)=>{if(!(i.length>=50)){if(o.test(e)){const o=l.relative(n,r);i.push(`${o}:${t+1}: ${e.trim()}`)}o.lastIndex=0}})}catch{}}}}(o),0===i.length?`No matches found for "${t.pattern}"`:`Found ${i.length} match(es):\n${"â”€".repeat(50)}\n${i.join("\n")}`}catch(e){return`Error: ${e instanceof Error?e.message:"Search failed"}`}}},{name:"get_selection",description:"Get the currently selected text in the active editor",parameters:{type:"object",properties:{},required:[]},execute:async()=>{const e=a.window.activeTextEditor;if(!e)return"No active editor";const t=e.selection,n=e.document.getText(t);return n?`Selected text from ${l.basename(e.document.fileName)} (lines ${t.start.line+1}-${t.end.line+1}):\n${"â”€".repeat(50)}\n${n}`:"No text selected"}},{name:"get_open_file",description:"Get the full content of the currently open file in editor",parameters:{type:"object",properties:{},required:[]},execute:async()=>{const e=a.window.activeTextEditor;if(!e)return"No file is open";const t=l.basename(e.document.fileName),n=e.document.getText().split("\n").map((e,t)=>`${(t+1).toString().padStart(4)}: ${e}`);return`File: ${t}\n${"â”€".repeat(50)}\n${n.join("\n")}`}},{name:"run_terminal_command",description:"Run a shell command. Use for npm, git, build commands etc.",parameters:{type:"object",properties:{command:{type:"string",description:"Shell command to run"}},required:["command"]},execute:async e=>{const t=v(e);return t.command?new Promise(e=>{const{exec:o}=n(317),i=a.workspace.workspaceFolders?.[0]?.uri.fsPath||"";o(t.command,{cwd:i,timeout:3e4},(n,o,i)=>{if(n)e(`Error: ${n.message}\n${i}`);else{const n=o||i||"Command completed (no output)";e(`$ ${t.command}\n${"â”€".repeat(50)}\n${n}`)}})}):"Error: command parameter is required. Received: "+JSON.stringify(e)}},{name:"show_diff",description:"Show a diff preview of changes without applying them",parameters:{type:"object",properties:{path:{type:"string",description:"File path"},new_content:{type:"string",description:"Proposed new content"}},required:["path","new_content"]},execute:async e=>{const t=v(e);if(!t.path)return"Error: path parameter is required. Received: "+JSON.stringify(e);const n=a.workspace.workspaceFolders?.[0]?.uri.fsPath;if(!n)return"Error: No workspace folder open";const o=l.join(n,t.path);try{const e=(c.existsSync(o)?c.readFileSync(o,"utf-8"):"").split("\n"),n=(t.new_content||"").split("\n"),i=[`Diff for ${t.path}:`,"â”€".repeat(50)],s=Math.max(e.length,n.length);for(let t=0;t<s;t++){const o=e[t]||"",s=n[t]||"";o!==s&&(void 0!==e[t]&&i.push(`- ${t+1}: ${o}`),void 0!==n[t]&&i.push(`+ ${t+1}: ${s}`))}return i.join("\n")}catch(e){return`Error: ${e instanceof Error?e.message:"Could not generate diff"}`}}}]},857(e){e.exports=require("os")},896(e){e.exports=require("fs")},928(e){e.exports=require("path")}},t={},n=function n(o){var i=t[o];if(void 0!==i)return i.exports;var s=t[o]={exports:{}};return e[o].call(s.exports,s,s.exports,n),s.exports}(265);module.exports=n})();